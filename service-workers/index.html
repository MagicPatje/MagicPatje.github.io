<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Home Page</title>
</head>

<body>
    <div style="text-align:center; margin-top:40px;">
        <p>Registration status: <strong id="status"></strong></p>
        <p>State: <strong id="state"></strong></p>
        <p>Network status: <strong id="nStatus"></strong></p>
        
        <div id="request" style="display: none">
            <input id="long-url" value="https://www.packtpub.com/" size="50">
            <input type="button" id="url-shorten-btn" value="Shorten URL" />
        </div>
        <div>
            <input type="checkbox" id="mock-checkbox" checked>Mock Response</input>
        </div>
        <div>
          <br />
          <a href="" id="short-url"></a>
        </div>
    </div>
    
    <script>
        function printState(state) {
            document.getElementById('state').innerHTML = state;
        }
        function printStatus(status) {
          document.getElementById('nStatus').innerHTML = status;
        }
        
        function showRequest() {
          document.getElementById('url-shorten-btn').addEventListener('click', sendRequest);
          document.getElementById('request').style.display = 'block';
        }

        function sendRequest() {
          var xhr = new XMLHttpRequest(),
            request;

          xhr.open('POST',
            'https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyCr0XVB-Hz1ohPpjvLatdj4qZ5zcSohHsU');
          xhr.setRequestHeader('Content-Type', 'application/json');

          if (document.getElementById('mock-checkbox').checked) {
            xhr.setRequestHeader('X-Mock-Response', 'yes');
          }

          xhr.addEventListener('load', function() {
            var response = JSON.parse(xhr.response);
            var el = document.getElementById('short-url');

            el.href = response.id;
            el.innerHTML = response.id;
          });

          request = {
            longUrl: document.getElementById('long-url').value
          };

          xhr.send(JSON.stringify(request));
        }
        
        if ('serviceWorker' in navigator) {

          navigator.serviceWorker.register(
            'service-worker.js',
            { scope: './' }
          ).then( function(registration) {
            var serviceWorker;
            document.getElementById('status').innerHTML = 'successful';

            if (registration.installing) {
              serviceWorker = registration.installing;
              printState('installing');
            } else if (registration.waiting) {
              serviceWorker = registration.waiting;
              printState('waiting');
            } else if (registration.active) {
              serviceWorker = registration.active;
              printState('active');
            }

            if (serviceWorker) {
              printState(serviceWorker.state);

              serviceWorker.addEventListener('statechange', function(e) {
                printState(e.target.state);
              });
            }
          }).catch(function(error) {
            document.getElementById('status').innerHTML = error;
          });
        } else {
            document.getElementById('status').innerHTML = 'unavailable';
          }
    </script>
</body>

</html>
